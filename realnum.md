# realnum 实数(小数)

`{i{min,max}}` 表达的是 [bigint](bigint.md) 范围，很多情况下我们需要实数范围，整数就难以实现了。

我们之所以用**实数**这个词，而不是用**浮点数**，是因为在 RuleDB 中，实数也是用字符串表达的，并且没有精度限制，没有精度限制的**实数**，自然不是**浮点数**。

实数范围使用 `{r{min,max}}` 来表达，和 `{i{min,max}}` 一样，`min` `max` 省略时表示无穷：

`{r{min,max}}` | 闭区间 $$[min,max]$$
---------------|:----------------------------
`{r{,max}}`  | 区间 $$(-\\infty, max]$$ ，表示所有 **小于等于** max 的实数，max 可以为负数
`{r{min,}}`  | 区间 $$[min, +\\infty)$$ ，表示所有 **大于等于** min 的实数，min 可以为负数
`{r{,}}`     | 区间 $$(-\\infty, +\\infty)$$ ，表示所有所有实数，包含所有正负数和 0
实数的位数    | 没有限制，例如整数部分和小数部分都可以是 100万位

和通常的表达方式一样， `{r{min,max}}` 中的实数的小数部分可以省略，此时它仍然表示实数范围。

**注意**：这里的实数**不支持科学计数法**，匹配时也**不识别**文本中用科学计数法表达的实数。

## 例：经纬度

在 [geo-fields.md](geo-fields) 中，我们使用 geohash 来表达地理位置，geohash 是在数据库不支持多维索引的情况下的权宜之计。既然 RuleDB 支持多维索引，自然应当首选多维索引：

```bash
rule_db_build.sh \
    -F gender -F age -F income \
    -F interesting -F books \
    -F mindstatus \
    -F longitude -F latitude \
    -i 's{:}(gender,age,income)' \
    -i '(age,income)'  \
    -i '(interesting,books)' \
    -i '(longitude,latitude)' \
    -o OutputDir  InputRuleFile.txt
```

其中， `-i 's{:}(gender,age,income)'` 创建了以 `:` 为字段分隔符，按 `gender,age,income` 字段顺序创建的联合索引。其中 `s{:}` 可以省略，省略时用 `\0` 作为字段分隔符。

规则编译器对规则表达式创建索引，存在多个索引时，使用 DLX 算法求解最优覆盖，对规则表达式选择最优索引。
> [这里](https://github.com/topling/ruledb-doc/blob/main/bigint.md#%E5%A4%8D%E6%9D%82%E7%82%B9%E7%9A%84%E4%BE%8B%E5%AD%90) 展示了手动拼接索引项的例子，可用来了解索引的原理，加深理解。

对于以下规则：
```
gender{{1}} and age{i{20,28}} and income{i{18000,23000}} and \
longitude{r{116.2418,116.2441}} and \
latitude {r{39.5424,39.5450}} and \
interesting{{电影|美食|运动}} and \
books{{红楼梦|了不起的盖茨比}} and \
mindstatus(吃点啥){filter}   <tab> 全聚德的广告定向条件(业务数据)
```

规则编译器生成的索引项为：
```
# 在索引 i-gender-age-income 中：
{{1}} : ":" . {i{20,28}} : ":" . {i{18000,23000}}

# 在索引 i-interesting-books 中：
{{电影|美食|运动}} : "\0" . {{红楼梦|了不起的盖茨比}}

# 在索引 i-longitude-latitude 中：
{r{116.2418,116.2441}} : "\0" . latitude {r{39.5424,39.5450}}
```

索引 `(age,income)` 被自动忽略，因为 `(gender,age,income)` 是更优的索引。

其中有两种串接操作符， `:` 和 `.` ， `A : B` 用来避免 A 的末尾恰好与 B 相同时引起的混淆， `.` 是普通串接。

因为 `吃点啥` 的召回率太高，给它添加了 `filter` 标志，从而它不参与规则召回，只参与规则验证。

细心的人可能注意到了：上述经纬度的写法是 $$116.2418$$ 这样的，而不是 $$116°24'18$$，并且 $$116.2418$$ 在数值上也显然不是这个经度的小数形式。其实原因是：RuleDB 并不知道 $$116.2418$$ 对应的实数是什么，它只把 $$116.2418$$ 当做字符串，只要输入中用来表达经度的的字符串形式上处于实数意义上的 $$[116.2418,116.2441]$$ 范围内，它就接受，例如它会接受 $$116.6160$$ 这样的字符串，而它对应的经度 $$116°61'60$$ 是非法的(角度的分、秒是60进制)。

于是：当有个文艺青年在王府井逛街时发了一条状态**该吃点啥呢**，他就被推荐了全聚德。（前述经纬度范围是王府井）

注意事项：
1. 创建的索引保持用户指定的字段顺序
1. 规则表达式中的 and(&) 条件无顺序要求
